services:
  activepieces:
    # Use build: . to include local changes (the keycloak integration)
    build: .
    # image: ghcr.io/activepieces/activepieces:0.74.3
    container_name: activepieces
    restart: unless-stopped
    ports:
      - '8080:80'
    depends_on:
      - postgres
      - redis
      - keycloak
    env_file: .env
    environment:
      # Keycloak Configuration for ActivePieces
      # AP_KEYCLOAK_AUTH_URL: Accessed by browser (external/host)
      - AP_KEYCLOAK_AUTH_URL=http://localhost:8090/realms/activepieces/protocol/openid-connect/auth
      # AP_KEYCLOAK_TOKEN_URL: Accessed by backend (internal docker network)
      - AP_KEYCLOAK_TOKEN_URL=http://keycloak:8080/realms/activepieces/protocol/openid-connect/token
      # AP_KEYCLOAK_USERINFO_URL: Accessed by backend (internal docker network)
      - AP_KEYCLOAK_USERINFO_URL=http://keycloak:8080/realms/activepieces/protocol/openid-connect/userinfo
      # AP_KEYCLOAK_JWKS_URL: Accessed by backend (internal docker network) - Explicitly set to avoid deriving from Auth URL
      - AP_KEYCLOAK_JWKS_URL=http://keycloak:8080/realms/activepieces/protocol/openid-connect/certs
      - AP_KEYCLOAK_CLIENT_ID=activepieces
      - AP_KEYCLOAK_CLIENT_SECRET=secret
    volumes:
      - ./cache:/usr/src/app/cache
    networks:
      - activepieces

  postgres:
    image: 'postgres:14.4'
    container_name: postgres
    restart: unless-stopped
    env_file: .env
    environment:
      - 'POSTGRES_DB=${AP_POSTGRES_DATABASE}'
      - 'POSTGRES_PASSWORD=${AP_POSTGRES_PASSWORD}'
      - 'POSTGRES_USER=${AP_POSTGRES_USERNAME}'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - activepieces

  redis:
    image: 'redis:7.0.7'
    container_name: redis
    restart: unless-stopped
    volumes:
      - 'redis_data:/data'
    networks:
      - activepieces

  keycloak:
    image: quay.io/keycloak/keycloak:26.0.0
    container_name: keycloak
    command: start-dev --import-realm
    volumes:
      - ./deploy/keycloak-realm.json:/opt/keycloak/data/import/realm.json
    environment:
      KC_DB: dev-file
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8090:8080"
    networks:
      - activepieces

volumes:
  postgres_data:
  redis_data:
networks:
  activepieces:
